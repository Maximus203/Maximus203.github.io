name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  install:
    name: ğŸ“¦ Installation des dÃ©pendances
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ”§ Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Installation des dÃ©pendances npm
        run: |
          echo "Installation des dÃ©pendances..."
          npm ci
          echo "âœ… DÃ©pendances installÃ©es avec succÃ¨s"

      - name: ğŸ› ï¸ Installation de tsx
        run: |
          echo "Installation de tsx pour la gÃ©nÃ©ration du sitemap..."
          npm install -D tsx
          echo "âœ… tsx installÃ©"

      - name: ğŸ’¾ Cache des node_modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

  build:
    name: ğŸ—ï¸ Build du projet
    runs-on: ubuntu-latest
    needs: install
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ”§ Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Restauration du cache
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: ğŸ“¦ Installation (si cache manquant)
        run: |
          if [ ! -d "node_modules" ]; then
            npm ci
            npm install -D tsx
          fi

      - name: ğŸ—ºï¸ GÃ©nÃ©ration du sitemap
        run: |
          echo "GÃ©nÃ©ration du sitemap.xml..."
          npm run generate-sitemap
          echo "âœ… Sitemap gÃ©nÃ©rÃ©"

      - name: ğŸ—ï¸ Build Vite
        run: |
          echo "DÃ©marrage du build de production..."
          npm run build
          echo "âœ… Build terminÃ© avec succÃ¨s"

      - name: ğŸ“Š Informations du build
        run: |
          echo "ğŸ“‚ Contenu du dossier dist:"
          ls -lah dist/
          echo ""
          echo "ğŸ“ Taille totale:"
          du -sh dist/

      - name: ğŸ“¤ Upload de l'artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-files
          path: ./dist
          retention-days: 1

  deploy:
    name: ğŸš€ DÃ©ploiement sur GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸ“¥ TÃ©lÃ©chargement de l'artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-files
          path: ./dist

      - name: âš™ï¸ Configuration de GitHub Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“¦ Upload vers GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

      - name: ğŸš€ DÃ©ploiement sur GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: âœ… DÃ©ploiement terminÃ©
        run: |
          echo "ğŸ‰ Portfolio dÃ©ployÃ© avec succÃ¨s!"
          echo "ğŸ”— URL: ${{ steps.deployment.outputs.page_url }}"
